---
title: "expByR"
author: "Nakazato T."
date: "2019/6/12"
output: html_document
---

## この文章の設定
（一応 残してある）
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy = FALSE)

if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install()
BiocManager::install("GEOquery")
library("GEOquery")
```

# Rで遺伝子発現解析

マイクロアレイデータを例に遺伝子発現データをR言語で処理してみて、発現に差のある遺伝子をピックアップし、（外部のエンリッチメント解析ウェブサービスを利用して）生物学的に解釈するというのをやってみた。
（あくまでRの勉強用なので、一部 簡略化しているところがある）
（参考までに同じことをExcelでやった「Excelでなぞる遺伝子発現解析」もあります）

## Rを使う際の環境設定
本格的にRを使うことになると、ファイルの読み込みや保存を行うようになります。そのための場所をworking directoryと言います。getwd()で確認できます。
```{r}
getwd()
```

このworking directoryですが、Rでは特についつい場所を見失いがちです。なので、あらかじめworking directoryを決めておいて、そこにファイルの保存をしたりするようにしましょう。
- Mac だと、~/r とか
- Win だと、C:/Usrs/自分の名前/Documents とか

working directoryを変更するにはsetwd()コマンドを使います。
```{r eval=FALSE, include=FALSE}
setwd("~/r/expByR")
```
（この操作は環境を変更するため、実行できないようにしています）

ファイルのリストが右下のウインドウにあるので、それが利用可能かも
このセクションをがっつり削るか?


## GEOからの遺伝子発現データの取得
- GEO (Gene Expression Omnibus) は、NCBIが集めている遺伝子発現のデータベース
  - もともとはマイクロアレイのデータベースだったがNGS（次世代シーケンサー）が出てきてRNA-Seqのデータもここに入ることになり、今は遺伝子発現データのデータベースとなっている。
  - てなわけで今はNGSデータの方がはやりなのだが、NGSデータの解析自体で1回の講義になってしまうレベルだし、コマンドラインや計算機リソースを駆使するような計算なので、今回はある程度そのあたりを計算済ということでマイクロアレイのデータを例とする。
- あらためまして、GEOのサイトにアクセスするのだが、今回は混乱を避けるために測定データセットを検索するサイトを示しておく。 https://www.ncbi.nlm.nih.gov/gds/
- 生物種名や生命現象を検索ボックスに入れて、どのようなデータがあるか楽しんでみましょう
  - 詳細まで見るといくつかのパターンがあることがわかります
    - 正常と疾患/変異株/薬剤処理など状態を2群間で比較するデータ
    - ある状態下でのさまざまな臓器など多サンプル間で比較するデータ
    - 薬剤処理後の時間経過ごと、発生ステージなどなどの時系列データ
- 今回は、GSE15515 ：Transcriptome Profiles of Differentiated arabidopsis Leaf Cells and Dedifferentiating Protoplasts of Ler and kyp mutant （シロイヌナズナ Ler および kyp 変異体における分化した葉細胞と脱分化したプロトプラストでのトランスクリプトーム [全遺伝子発現] プロファイル）を用いることとします。 
https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE15515
- Samples の項目を見ると、どういうサンプル（試料・材料）を使って実験をしたかが書いてあります
  - 上の比較データか、時系列データか意識して、どれがセットか考えるといいでしょう
  - 場合によっては同じようなデータを何回もとっているものがあります。
    - 同じサンプルを何回か測定：technical replica。複数やることで実験操作を相殺する
    - 別個体で何回か測定：biological replica。複数やることで個体差を相殺する
- その下のところに実際の遺伝子発現データがダウンロードできる形で置いてあるが、単純な表にはなっていないので加工が必要なのだが、Rだとマイクロアレイ用のパッケージをインストールすることでデータを読み込むことができる。
```{r}
data <- getGEO("GSE15515")
```

```{r}
hoge <- sapply(data, annotation)
for(i in 1:length(hoge)){
  out_f <- paste("GSE15515_", hoge[i], ".txt", sep = "")
  write.exprs(data[[i]], file=out_f)
}
```

```{r}
data2 <- read.table(out_f, header = TRUE, row.names = 1, sep = "\t", quote = "")
```


最大、最小、中央値、平均値を求める
```{r}
summary(data2)
```



  - SOFT formatted family file(s)
  - Series Matrix File(s)
- 今回はこのデータをもとに講義用に加工したデータ([GSE15515.for_lecture.txt](../data/GSE15515.for_lecture.txt))を使って説明する。（のでダウンロードしておく）
  - 本サイト（Github）から落とす場合は、リンクをたどったのち、ダウンロードボタンを右クリックしてリンク先を保存（もしくはそれに類するもの）を選んで保存する。


## 解析の目標
- Arabidopsis（シロイヌナズナ）の葉とプロトプラスト（細胞壁を薬品的に除去した状態）でどんな機能の遺伝子が特異的に（=その状態のみで）働いているか?（または働いていないか?）


## 遺伝子発現データの統計的な解析

### ファイルを開く
- とりあえず上で読み込んでいる


### データの分布を調べてみる
- データの列には遺伝子の発現量が数値で入っている
  - GEOに登録してあるのは対数値なのですが、Excelで対数をとる演習のために今回はわざわざ数値を元に戻しています
- ちらちら眺めると0に近い値から数千まで数値があるような
- そこで、各列の一番下の行で最大値と最小値を計算してみましょう


最大、最小、中央値、平均値を求める
```{r}
summary(data2)
```

- 考察：左2列がleaf、右2列がprotoplast。これからその2列どうしの数値の平均をとるが、特に中央値や平均値が大きくずれていないので、2列のデータの分布はほぼ同じそうだと期待でき、特に補正（正規化という）をせずに先に進むこととする。（というか実際はすでに補正済のデータが登録されていたのだろう）

### 2つの状態での発現量を比較する

### 発現量比較のデータを眺めてみる
- ヒストグラム
```{r}
hist(data2$GSM388810, breaks = 60)
```

- scatter plot
```{r}
plot(data2$GSM388810, data2$GSM388814)
```

## 発現に差のある遺伝子の機能解析
- **覚えていますか**：[解析の目標] Arabidopsis（シロイヌナズナ）の葉とプロトプラスト（細胞壁を薬品的に除去した状態）でどんな機能の遺伝子が特異的に（=その状態のみで）働いているか?（または働いていないか?）

### 発現に差のあるデータの絞り込み

### 遺伝子機能解析
- ここから遺伝子機能解析を専門のサイトでやります。
- DAVIDでググる。と、DAVID Functional Annotation Bioinformatics Microarray Analysis というサイトが出てくる（はず）。クリックしてそのサイトに行く
  - ちなみに https://david.ncifcrf.gov/
  - DAVIDは（遺伝子機能による）エンリッチメント解析ということをやるサイトです。ランダムに選んだ遺伝子セットに対して、この遺伝子セットは顕著にこの機能が多いですね、みたいなものを可視化してくれます。
- タイトル下の Start Analysis をクリック
- 画面が切り替わり、左カラムに入力ボックスが現れる
- Excelに戻って、IDをコピーする
  - A列で（見た目で）2行目から一番下まで（max とか # of dataはいらない）をコピーする
  - DAVIDのPaste a listにペースト
- ペーストした下の方の Step 3 でGene Listを選ぶ
- Step 4でSubmit Listをポチる
- 左カラムでArabidopsisなどと出れば成功
  - 返ってこないときは、タイトル下にあるDevelopment siteの方に行ってから同じことをする
- Functional Annotation Toolをクリック
- 機能解析メニューが出てくる
- よく使うのは Gene Ontology
  - Ontologyというのは階層型の用語集
    - 階層型というのは 人体 > 泌尿器系 > 腎臓 > 糸球体 のようなこと
- 解析その1：GOTERM_CC_ALL の右のChartをクリック
  - CCは cellular component 。細胞内の場所、の意味
  - 今回は一番上に cell wall （細胞壁）が出てくる
  - もともとの2群の違いは細胞壁があるかないか
  - いいじゃないか
- 解析その2：GOTERM_MF_ALL の右のChartをクリック
  - MFは molecular function。直訳だと分子機能。遺伝子そのものの機能的な（次のbiological processとも似る）
  - 一番上は「xyloglucan:xyloglucosyl transferase activity」
  - xyloglucan とはなんぞ? ググる
  - Wikipedia に「双子葉植物の一次細胞壁には普遍的に含まれ、セルロースミクロフィブリル間を架橋している。」とある
  - transferase（転移酵素）は原子群の場所を移動させる酵素
  - いいじゃないか
- 解析その3：GOTERM_BP_ALL の右のChartをクリック
  - BPは biological process。Molecular Functionが集まって起きる何か、のようなもの
  - 一番上は「glucosinolate biosynthetic process」
  - glucosinolate とはなんぞ? ググる
  - Wikipediaには「グルコシノレート は、カラシナやキャベツ、ワサビなどの辛味をもつアブラナ目の多くに含まれる二次代謝産物の一種である。」とある。確かにArabidopsisはアブラナ科だ。。。なるほど
- その他
  - PathwayのEC番号（酵素番号）やKEGG Pathwayなどを眺めてみてもよい

## まとめと発展
- Excelで統計の手法で遺伝子を絞り込み、機能解析をしてみた
- よくR言語での〜というのがあるが、Excelでもこのくらいならできる
  - 昔は256列までしか扱えなかったので、しんどかった時代もある
- 今回は、protoplastで発現の高い遺伝子について解析したが、もちろんleafで発現の高い遺伝子についても同様の解析をやってみたりする。
- さらに、今回は発現の高い遺伝子「セット」で解析をしたが、そこに含まれる実際の遺伝子は何か、というのをマイクロアレイのプローブIDから遺伝子名に直して眺めたりするわけである。
  - GEOのサイトにあるSOFT formatted family file(s)には対応表が載っているので、あらかじめそれをExcelででも列追加して解析を始めるか、あとで個別に眺めるかするわけである
- さらに今回は、葉とプロトプラストという2群だったが、前提条件が、葉と葉を薬剤処理したもの、というものだと、「どうやらこの薬剤は細胞壁の合成に何らかの関係があるらしい」というようなことが言えるわけだ。
  - というわけで、「通常と薬剤処理の細胞」、「通常期と繁殖期の魚」、「淡水型と海水型の魚」、「春型と夏型のチョウ」、「タバコを吸う人と吸わない人」などなどの前提条件と、条件の違いで遺伝子発現がどう変化するかというような研究が考えられるわけだ。
- **生物統計というと、ついついどんな統計手法で、と統計の方に目がいってしまうが、生物学のゴールは統計処理でなくて、そこで得られた遺伝子セットを生物学的に解釈する（そして最初の実験条件と照らし合わせる）、というところなのをお忘れなく。**



