---
title: "expByR"
author: "Nakazato T."
date: "2020/6/23"
output: html_document
---

# Rで遺伝子発現解析

マイクロアレイデータを例に遺伝子発現データをR言語で処理してみて、発現に差のある遺伝子をピックアップし、（外部のエンリッチメント解析ウェブサービスを利用して）生物学的に解釈するというのをやってみた。
（あくまでRの勉強用なので、一部 簡略化しているところがある）
（参考までに同じことをExcelでやった「Excelでなぞる遺伝子発現解析」もあります）

## 背景
### 今回 利用するデータ
- GSE15515 ：Transcriptome Profiles of Differentiated arabidopsis Leaf Cells and Dedifferentiating Protoplasts of Ler and kyp mutant （シロイヌナズナ Ler および kyp 変異体における分化した葉細胞と脱分化したプロトプラストでのトランスクリプトーム [全遺伝子発現] プロファイル） https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE15515
- 今回はこれを加工したデータを用いる ([GSE15515.for_lecture.tsv](https://raw.githubusercontent.com/chalkless/lecture/master/biostats/data/GSE15515.for_lecture.tsv))。あらかじめダウンロードしておく。（右クリックして「名前をつけて保存」）

### 生物学的背景
- 多細胞生物は、受精卵から細胞分裂して、人間であれば血球、神経、皮膚などなどさまざまな細胞に特化していく。この特化のことを分化という。
分化は不可逆的で、動物の場合は一般的には血球や皮膚などに分化した細胞から、未分化状態には戻れない。（植物の場合は、薬品処理をしたりするなどすると戻れる）
- 今回は分化した葉の細胞と、未分化状態に戻したプロトプラスト（薬品処理して細胞壁を破壊し、未分化状態に戻した）で遺伝子の発現状況を比較して、葉の状態のみ、プロトプラストの状態のみで発現している（＝働く）遺伝子はどういう機能があるのか、というのを確認する。
- （はしょって言えば）これのヒト版が京大・山中先生がノーベル賞をとったiPS細胞の話（成熟した細胞の多能性を持つ細胞への初期化）である（今回のと同様に解析したければ、元データは https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE18226 からダウンロードできる。が、次に述べる加工は必要）


## Rを使う準備編
- 本格的にRを使うことになると、ファイルの読み込みや保存を行うようになります。そのための場所をworking directoryと言います。getwd()で確認できます。
```{r}
getwd()
```

- このworking directoryですが、Rでは特についつい場所を見失いがちです。なので、あらかじめworking directoryを決めておいて、そこにファイルの保存をしたりするようにしましょう。
  - Mac だと、~/r とか
  - Win だと、C:/Usrs/自分の名前/Documents とか

- working directoryを変更するにはsetwd()コマンドを使います。
```{r eval=FALSE, include=FALSE}
setwd("~/r/expByR")
```
  -（この操作は環境を変更するため、実行できないようにしています。実行するときは eval=FALSE を削ってから実行のこと。もしくはRStudioだと画面左下の部分にConsoleがあるので、そこで実行するのがいいかもしれない）
  - RStudioだとファイルのリストが右下のウインドウにあるので、それが利用可能かもしれません。


## 解析の目標
- Arabidopsis（シロイヌナズナ）の葉とプロトプラスト（細胞壁を薬品的に除去した状態）でどんな機能の遺伝子が特異的に（=その状態のみで）働いているか?（または働いていないか?）


## 遺伝子発現データの統計的な解析

### ファイルを開く
- 今回はタブ区切り（tsv: tab separated value）ファイル。
- 改めてだが、今回はGEOから取得したデータを加工した ([GSE15515.for_lecture.tsv](https://raw.githubusercontent.com/chalkless/lecture/master/biostats/data/GSE15515.for_lecture.tsv)を使って説明する。（ので右クリックでダウンロードしておく）
```{r}
file_use <- "GSE15515.for_lecture.tsv"
data <- read.table(file_use, header = TRUE, row.names = 1, sep = "\t")
```
  - ファイルが開けない場合（「コネクションを開くことができません」「No such file or directory」といったメッセージの場合）は、```getwd()```でRがどこを確認しに行っているか確認のこと。ここの結果に開きたいファイルを置くか、上の方にある```setwd("...")```を書き換えて実行しファイルが見えるようにする。
```{r}
getwd()
```
  - Windowsでいうところのメモ帳で開くような（専門的にはエディターと呼ばれるソフトで開くような。人間の読める）ファイルをテキストファイルというが、Rで扱うようなファイルにはタブ区切りの他にCSVファイル（カンマ区切り：comma separated value）がある。その場合、sep（区切り文字）を\tでなく , にするか、read.tableでなくread.csvを用いる。
  - header は、1行目に列ラベルがついているかどうか。ついていればTRUE、ついていなければFALSE
  - row.names = 1: 1列目をデータでなく、行の名前として用いる（これを指定しないと、Rが勝手に1から行の名前を振っていって、この場合、プローブIDもデータとして扱われる）
- 読み込まれたデータを確認してみる
```{r}
data
```
  - Console画面だと多くの行が出てしまって確認しづらいので、とりあえず先頭のときは```head(data)```で確認できる。
  - また、RStudioでの場合は、```View(data)```とすると別タブでスプレッドシートのような（Excel-likeな）画面が表示される。
- 今回はID_REF（プローブ名）, leaf1, leaf2, protoplast1, protoplast2 というデータ構成になっている。

### データの分布を調べてみる
- データの列には遺伝子の発現量が数値で入っている
  - GEOに登録してあるのは対数値なのですが、行に対して計算をする（今回は対数をとる）演習と、あとで平均をとるので今回はわざわざ数値を元に戻しています（なので、先ほどGEOからとってきたファイルと中身が違います）
- ちらちら眺めると0に近い値から数千まで数値があるような
- そこで、各列で最大値を計算してみましょう。
  - 今回の場合、各列について計算をしてみます
```{r}
max(data$leaf1)
max(data$leaf2)
max(data$protoplast1)
max(data$protoplast2)
```
  - このように各列全体をさすには「データ名$列名」のようにします。
- 同様にして最小値（min）、平均値（mean）、中央値（median）も計算すれば良いのですが、Rの場合、表全体に対してまとめて各列の統計を出す関数が用意されているのでそれを使いましょう。
```{r}
summary(data)
```

- 暫定的な考察：左2列がleaf、右2列がprotoplast。これからその2列どうしの数値の平均をとるが、特に中央値や平均値が大きくずれていないので、2列のデータの分布はほぼ同じそうだと期待でき、特に補正（正規化という）をせずに先に進むこととする。（というか実際はすでに補正済のデータが登録されていたのだろう）
- Rの場合、本当にずれていないかどうかをすぐに可視化できるのでleaf1 vs leaf2とleaf1 vs protoplast1で散布図を描いて確認してみましょう。
```{r}
plot(data$leaf1, data$leaf2)
plot(data$leaf1, data$protoplast1)
```
- 統計値は似ていても分布は全然違うことがわかりました。

### 2つの状態での発現量を比較する
- 左2列のleaf、右2列のprotoplastをそれぞれ2回実験をしたとみなして、誤差を補正するために平均をとることとする。
```{r}
data$ave_leaf <- rowMeans(data[,1:2])
data$ave_protoplast <- rowMeans(data[,3:4])
```
  - ```data$ave_leaf <- ...``` のようにすることによって、表に1列足す形で結果を追加している。
  - 本当はrowMeansは行列全体で行ごとの和を出すものなので、行列名（データ名）を引数に渡せばいいのだが、今回は2タイプが混じっているのでこのようにしている。
  - [, 1:2] の部分は列番号（この場合、1列目から2列目まで）。もしかして列番号でなくて列名（leaf1など）で指定ができるかもしれないが、見つけきれなかったのでこうしている。
- 同様に計算した平均に対して対数をとる。
  - 別に底は2でも10でもいいのだが、マイクロアレイの解析の時は、伝統的に「発現比2倍以上」というデータの絞り込みをしていたため、わかりやすくするために底は2を用いている。（というか、そういうこともわかりやすくするために対数をとるのである）
```{r}
data$log_leaf <- log2(data$ave_leaf)
data$log_protoplast <- log2(data$ave_protoplast)
```

- 発現比を計算する。
- **今回やりたいのは、元のデータが何倍の発現量差があるかなので、対数の比をとるのでなく、比をとった後で対数をとる**
  - 覚えていますか：log(A/B) = log(A) - log(B)
```{r}
data$diff <- data$log_leaf - data$log_protoplast
```

### 発現量比較のデータを眺めてみる
- diff 列のデータの意味を振り返ってみる
  - `diff = 2` ：log(diff)=2 だから2^2で4倍の発現差がある。この場合、leafの発現が高い
  - `diff = -2`：log(diff)=-2 だから1/(2^2)で1/4倍の発現差がある。この場合、leafの発現が1/4だから、protoplastの方が4倍発現が高い
  - `diff = 0`：log(diff)=0 ということ。つまり、2^0=1。ようするに、leafとprotoplastで発現量が同じということ
- 試しに diff 列について、`max`, `min`, `mean`, `median` を計算してみる
```{r}
summary(data$diff)
```
  - 特にaverage、medianはほぼ0のはず。（というか、元の分布がそうなるようにすでに補正してあるわけである）
- 実際のデータの分布がどんなかヒストグラムを描いて確認してみる
```{r}
hist(data$diff)
```
- ちょっとグラフが荒いので、もう少し柱の幅を小さくしてみる
```{r}
hist(data$diff, breaks = 120, col = "pink")
```
- hist関数でヒストグラムが描画される
  - 0 を中心に左右対称になっている
  - breaks の数は柱を何本立てるかを指定していると思ってください。
- 実際のデータで分布がどうなっているかも散布図 (scatter plot) で確認することとする
```{r}
plot(data$log_leaf, data$log_protoplast, col = "orange")
```
- leafとprotoplastで発現変化がないと、log(leaf)=log(protoplast)、つまりy＝x の上に載りますということ。上のグラフに追加することもできる。
```{r}
plot(data$log_leaf, data$log_protoplast, col = "orange")
abline(0,1, col = "blue")
```
  - abline(b, a) は、y=ax+b を描画している
  - 普通はablineの中で、add = "T" を記載してグラフを重ね合わせるのだが、中にはablineのように（えてして単純な）グラフは何も指定しないと直前のグラフエリアに描画されるようになっている。
- 散布図 (scatter plot) を眺めてみる
  - 青線から離れるほど、発現が変わっている
  - 下に離れるとleafで発現が大きい、上に離れるとprotoplastで大きい

## 発現に差のある遺伝子の機能解析
- **覚えていますか**：[解析の目標] Arabidopsis（シロイヌナズナ）の葉とプロトプラスト（細胞壁を薬品的に除去した状態）でどんな機能の遺伝子が特異的に（=その状態のみで）働いているか?（または働いていないか?）

### 発現に差のあるデータの絞り込み
- leafで発現の高い遺伝子のみを抽出してみる。今回は試しに8倍以上にしてみる
  - 8 という数字は適当です。
  - 適当というのは、まぁ、こんなもんかな、ってことです。
  - どうしてまぁ、こんなもんかなって思うかは、試しに絞り込んでみて、（全体が20000くらいに対して）いくつくらいに絞り込めるかとか、結果を見てみたらきれいになったとか、信頼度がどのくらいかとか、そういうので決めているだけで、統計的にかっちり基準があるわけではありません。
  - またあとでこのあたりは出てきます
- 今回は8倍以上なのでlog2をとって3以上にしている
```{r}
data_x3 <- data[data$diff>=3,]
data_x3
```
- RStudioだと右カラムにデータの中身やサイズが書かれている。今回の場合、data_x3 は 915 obs. とあるので、ようするに、915行のデータがあるわけだ。
  - ちょっと多いなぁ。。。
  - というわけで、対数で5（実データで32倍）くらいにしてみる
- 対数で5以上にしてみる。
```{r}
data_x5 <- data[data$diff>=5,]
data_x5
```
  - 112個になった。
  - 今回はこのくらいで許してやろう
- さきほどの散布図で、対数で5以上の遺伝子の色だけ変えることもできる
```{r}
plot(data$log_leaf, data$log_protoplast, col = ifelse(data$diff>=5, "red", "orange"))
abline(0,1, col = "blue")
```
- 結果をファイルに出力してしまいましょう。
```{r}
file_rslt <- "GSE15515.up_5.txt"
write(rownames(data_x5), file_rslt)
```


### 遺伝子機能解析
- ここから遺伝子機能解析を専門のサイトでやります。
- DAVIDでググる。と、DAVID Functional Annotation Bioinformatics Microarray Analysis というサイトが出てくる（はず）。クリックしてそのサイトに行く
  - ちなみに https://david.ncifcrf.gov/
  - DAVIDは（遺伝子機能による）エンリッチメント解析ということをやるサイトです。ランダムに選んだ遺伝子セットに対して、この遺伝子セットは顕著にこの機能が多いですね、みたいなものを可視化してくれます。
- タイトル下の Start Analysis をクリック
- 画面が切り替わり、左カラムに入力ボックスが現れる
- IDを入力する。ファイルで指定できるので、先ほど保存したファイル（GSE15515.up_5.txt）を指定する。
- ペーストした下の方の Step 3 でGene Listを選ぶ
- Step 4でSubmit Listをポチる
- 左カラムでArabidopsisなどと出れば成功
  - 返ってこないときは、タイトル下にあるDevelopment siteの方に行ってから同じことをする
- Functional Annotation Toolをクリック
- 機能解析メニューが出てくる
- よく使うのは Gene Ontology
  - Ontologyというのは階層型の用語集
    - 階層型というのは 人体 > 泌尿器系 > 腎臓 > 糸球体 のようなこと
- 解析その1：GOTERM_CC_ALL の右のChartをクリック
  - CCは cellular component 。細胞内の場所、の意味
  - 今回は一番上に cell wall （細胞壁）が出てくる
  - もともとの2群の違いは細胞壁があるかないか
  - いいじゃないか
- 解析その2：GOTERM_MF_ALL の右のChartをクリック
  - MFは molecular function。直訳だと分子機能。遺伝子そのものの機能的な（次のbiological processとも似る）
  - 一番上は「xyloglucan:xyloglucosyl transferase activity」
  - xyloglucan とはなんぞ? ググる
  - Wikipedia に「双子葉植物の一次細胞壁には普遍的に含まれ、セルロースミクロフィブリル間を架橋している。」とある
  - transferase（転移酵素）は原子群の場所を移動させる酵素
  - いいじゃないか
- 解析その3：GOTERM_BP_ALL の右のChartをクリック
  - BPは biological process。Molecular Functionが集まって起きる何か、のようなもの
  - 一番上は「glucosinolate biosynthetic process」
  - glucosinolate とはなんぞ? ググる
  - Wikipediaには「グルコシノレート は、カラシナやキャベツ、ワサビなどの辛味をもつアブラナ目の多くに含まれる二次代謝産物の一種である。」とある。確かにArabidopsisはアブラナ科だ。。。なるほど
- その他
  - PathwayのEC番号（酵素番号）やKEGG Pathwayなどを眺めてみてもよい

## まとめと発展
- Rを用いて統計的に遺伝子を絞り込み、機能解析をしてみた
- 今回は、protoplastで発現の高い遺伝子について解析したが、もちろんleafで発現の高い遺伝子についても同様の解析をやってみたりする。
- さらに、今回は発現の高い遺伝子「セット」で解析をしたが、そこに含まれる実際の遺伝子は何か、というのをマイクロアレイのプローブIDから遺伝子名に直して眺めたりするわけである。
  - GEOのサイトにあるSOFT formatted family file(s)には対応表が載っているので、がんばれば列追加して解析を始めるか、あとで個別に眺めるかするわけである
- さらに今回は、葉とプロトプラストという2群だったが、前提条件が、葉と葉を薬剤処理したもの、というものだと、「どうやらこの薬剤は細胞壁の合成に何らかの関係があるらしい」というようなことが言えるわけだ。
  - というわけで、「通常と薬剤処理の細胞」、「通常期と繁殖期の魚」、「淡水型と海水型の魚」、「春型と夏型のチョウ」、「タバコを吸う人と吸わない人」などなどの前提条件と、条件の違いで遺伝子発現がどう変化するかというような研究が考えられるわけだ。
- **生物統計というと、ついついどんな統計手法で、と統計の方に目がいってしまうが、生物学のゴールは統計処理でなくて、そこで得られた遺伝子セットを生物学的に解釈する（そして最初の実験条件と照らし合わせる）、というところなのをお忘れなく。**
