# Excelで可視化する新型コロナデータ
- 新型コロナのデータを使ってExcelで統計解析の基礎や可視化をやってみようという試み

## [参考] 元データの入手と加工
- 元データ
  - NHK 新型コロナウイルス特設サイト( https://www3.nhk.or.jp/news/special/coronavirus/data/ )で配布されている各都道府県ごとの感染者数の推移データ(2021/6/14ダウンロード) ：https://raw.githubusercontent.com/chalkless/lecture/master/biostats/covid19/nhk_news_covid19_prefectures_daily_data.csv
  - ↑ これを右クリックして名前をつけて保存などする。
  - [愚痴] 厚労省とか内閣官房とかオープンデータとか言いながらろくなデータないし。都道府県別のデータだと累積データとか（それはここで毎日の陽性者数を計算する演習をしろってことですか）

## Excelでファイルを開く
- Excelを立ち上げる
  - クラウド版のExcel（ブラウザで開く方）だとCSV（に限らずタブ区切りなどExcel形式[.xlsx]以外すべて）のファイルの読み込みができないので、自分のコンピューターにインストールしたExcelを使うか、ファイルの保存までをGoogle Spreadsheetでやって、Excelで開き直すこと。
- 今回はカンマ区切り（csv: comma separated value）なので、テキストファイル（Windowsでいうところのメモ帳で開くファイル。Excel形式でないもの）として読み込む
  - Windowsの場合：シートの上にファイルをドラッグ&ドロップすると開くようです。もしくは、ファイル > 開く から。CSVだと型式を気にせず読み込めると思いますが、ファイルの形式をExcel形式でなくカンマ区切りファイル（CSV）（もしくはテキストファイル）を選択するとファイルのリストに表示される（or 選択できるようになる）
  - Macの場合：ファイル > 開く から。もしくは ファイル > インポート > CSVファイル
- 読み込みのダイアログがでた場合：区切り記号付き → 区切り文字コンマなどと選びながら次へを押していく
- 文字化けしたとき：ファイル > インポート > CSVファイルと進み、テキストファイルウィザード画面で「元のファイル：Japanese (MacOS)」となっているところを「Unicode (UTF-8)」に変える。とプレビューで都道府県名が読めるようになる。
- 1つのセルに全部のデータが入ってしまった時：ファイル > インポート > CSVファイル > ファイルウィザード画面1 > ファイルウィザード画面2 と進み、フィールドの区切り文字指定でカンマだけにチェックを入れる。プレビュー欄で各データの間に縦線が入っているのを確認する。
- 無事に開ける
  - ![データのファイルを開いた結果](./images/excel_openfile.png)
- **[ファイルの保存]** 何はともあれファイルの保存。ファイル > **名前をつけて保存でExcelブックとして保存**
  - 普通に（テキストファイルとして）保存してしまうと、関数やグラフが保存されないのでExcelブックの形式で保存する。

## グラフ作成・可視化の下準備
- 全体としては25000行程度のデータだが、今回は東京都の感染者の推移と最新の都道府県別の感染者の可視化を行う

### フィルター機能によるデータの絞り込み
- 大半は使わないデータなので、それを絞り込むためにフィルター機能を使う。
- ホームタブ > （場合によっては右の方の虫眼鏡マーク+編集の中の）並べ替えとフィルター > フィルターにチェックを入れる
- 1行目に▼印がつく
- 今回は日付、都道府県名、各地の感染者数_1日ごとの発表数の列だけを使うので他の列は非表示にしておくと便利。たとえば都道府県コードを表示しているB列の列ラベル（Bと書いてあるところ）で右クリックすると、表示しないと出るのでそこをクリックして選択する。逆に再表示させるときはA→Cとドラッグしたり、A列を選択後にShiftキーを押しながらC列を選択したりしたのち（ようするにBの前後の列を選択する）、右クリックから再表示を選択する。

## 陽性者数の推移の可視化
### 東京都での日ごとの陽性者数の推移
- 都道府県名の▼をクリックして東京都を選択する。（すべて選択を一度クリックしてすべてのチェックをはずしてから東京都を選ぶと便利）
- どこかデータのあるセルを選択して全選択（Win: Ctrl-A、Mac: ⌘+A）するとデータの部分がすべて選択されるので、とりあえずコピーし（Ctrl/⌘-C）、新しいシートを作成し（シート左下（この場合、nhk_news_covid19_prefectures_dataと書いてあるところ）の右の+マークをクリック）、データをコピーする。
- すべてが東京都のデータなので、都道府県名の列は非表示にする。
- グラフを描く：データを全選択して、挿入タブから好きなグラフを選ぶ。この場合は折れ線グラフか棒グラフがよいと思う。
- グラフがオブジェクトとして挿入されるので、大きさを変えたり、色を変えたりする。
![日ごとの陽性者数の推移のグラフ](./images/excel-flowSimple.png)

### [応用] 7日間平均の推移
- 曜日によって検査数にムラがあるので、日ごとの推移は1週間を周期に小さい波を打つ。（ギザギザする）
- その影響をなくすために7日間の平均を記載する。
- 日ごとの陽性者数の隣の列に7日間の平均を計算する。
  - たとえば1/22の7日間平均だと、(1/16〜22の総和)/7 となる
  - というか平均だから`=average(...)`関数を使えばいいのであった
  - 数式バーの隣のf(x)をクリックして関数を挿入する
  - 関数を検索するなどしてaverageを探して挿入
  - 範囲指定をする。7日間平均などという処理はExcel側は不慣れだろので、隣のC8だけ選択された状態になるかと思う。そこで1/16（C2）から1/22（C8）を選択する。選択するのは、マウスでドラッグしても良いし、C2を選択してShiftキーを押しながら↓キーでひとつずつなり、マウスでC8をクリックするなりなどする。
  - 結果として`=AVERAGE(C2:C8)`となる。
  - ホームタブの右上にある総和（Σ）を使って、`=SUM(C2:C8)/7`としてもよい
- 数式をコピーする
  - まずは画面を分割すると楽：表示タブ > （右の方の）分割を選択
  - 縦に区切ったのは不要なので、右端にでもドラッグして消す。横に区切ったものは上半分はシートの上の方、下半分はシートの下の方（この場合、516行目まであるのでそのあたり）を表示しておくと便利
  - 今、作成したD8セルを選択してコピー。ペーストする先の一番上であるD9セルをクリックすることで選択して、分割した先のD516をShiftキーを押しながらクリックすることで、コピー先を選択した状態にする（破線がくるくるした状態になる）
  - ペーストする（Ctrl-Vなど）。計算結果が出ればOK。
- 7日間平均のグラフを描く
  - 値が入っているセルを全選択する（値が入っているセルを選択したあとでCtrl-A。もしくはA1をクリックして、D516をシフトを押しながらクリック）
  - 挿入タブをクリックして折れ線グラフを選択。グラフが表示される。
![日ごとの陽性者数+7日間平均の推移のグラフ](./images/excel-flowAve.png)
- 先ほどつくった1日の陽性者数だけのグラフが消えてしまうかもしれないが、それはそれでご愛嬌
- あとはグラフのタイトルを（ダブルクリックするなりして）変更したり、色を変えてみたりなどができる。

## 都道府県ごとの感染者数
- ある日の都道府県ごとの感染者数を見てみましょう。（今回は2021年6月1日）
- 元データのシートに戻る（左下にシートの名前が出ている。今回はnhk-...かSheet1）
- C列でフィルターをかけている状態かと思うので（他の列は1行目に▼がついていると思うが、C列だけケータイのアンテナの状態）、ケータイのアンテナマークをクリックしてフィルターをはずす（フィルターのクリア）
- 日付でフィルターする。A列の▼をクリックして、すべて選択をクリックして一度選択をはずしてから、2021年の▶︎をクリックして▼に展開して適当に日付を選ぶ。（たとえば6/1など）
- 6/1の各都道府県の感染者数で絞り込まれる。
- データのあるセルをクリックして全選択（Ctrl-Aなど）。他のシートにデータをコピーする。（画面左下のシート名が書いてあるところにある+をクリックしてシートを追加。多分、A1セルが選ばれていると思うので、そのままペースト）
- A列は日付で使わないので非表示にする。
- 試しに棒グラフ
  - データの入っているセルをクリックして全選択
  - 挿入タブから棒グラフ
  - どの都道府県で陽性者数が多いかわかる。
- 同様に円グラフとか
  - データの入っているセルをクリックして全選択
  - 挿入タブ > グラフのところから円グラフ
  - あとはお好みで
    - グラフが小さいので、グラフエリア全体の大きさを変えるなど
    - 円グラフ上で右クリックしてデータ ラベルの追加など
    - 円グラフで改めて右クリックして データ ラベルの書式設定
    - 分類名にチェックを入れて値のチェックをはずす（逆にするとうまくいかない）
    - ![円グラフ](./images/excel-pie.png)
- 同様に日本地図とか
  - データの入っているセルをクリックして全選択
  - 挿入タブ > グラフのところからマップ
  - 地図が表示される。が世界地図
  - 地図の陸地あたりをクリックして選択。右クリックして「データ系列の書式設定」
  - マップ領域を「データが含まれる地域のみ」
  - マップ投影を「ミラー」か「メルカトル」
  - あとはお好みで。
    - 最小値を数値・0にするなど
    - 最大値の色を赤にするなど
    - データ系列の書式設定 の下のペンキをかけるマークを選択して枠線を線（単色）にするなど
![日本地図にマップする](./images/excel-map.png)


